<!doctype html>
<html>

	<iframe
		src="" id="form"
		width="0" height="0" frameborder="0" marginheight="0" marginwidth="0">
		Loadingâ€¦
	</iframe>

	<body onload="submit()">

		<p id="doc" style="opacity: 0;">abc</p>
		<p id="scantext" style="opacity: 100;"></p>
		
	</body>
	
	<!--
		https://docs.google.com/forms/d/e/1FAIpQLSf_Z3nol0PQztbRLilbfIA4XSbIXMroVQyyDc-SIpTzkSK5Eg/formResponse?&entry.1267494256=oof&submit=SUBMIT

		RickRoll
		dQw4w9WgXcQ

		September - Earth, Wind and Fire
		Gs069dndIYk

		AllStar - SmashMouth
		L_jWHffIx5E

		EEEAAAOOO - My Fucking Mess
		v1K4EAXe2oo

		Skeleton Dance - Silly Symphonies
		vOGhAV-84iI

		Tort Brush Mambo
		ZRTCwquyCHc

		Get Stick Bugged lol
		Tt7bzxurJ1I

		got legs?
		gSsJBO2JUO4

		he 10 hours
		3SCBYUE_X1U

		James May says Cheese
		SyimUCBIo6c

		Thurston the Cat (Full video)
		RRNanbmD1xk

		vibin'
		qMQ-y9dHE2k

		Sax Seal
		hgwpZvTWLmE

		Smooth Criminal
		h_D3VFfhvs4
	-->

	<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.js"></script>
	<script>
		
		async function submit() 
		{
			await getIP();
			var ip = document.getElementById('doc').innerHTML;
			var hash = CryptoJS.SHA256(ip);

			var ipsfromspreadsheet = await GetSpreadSheetData();

			// console.log(await fetch("https://api.ipify.org"));
			console.log(ipsfromspreadsheet);

			var FoundIp = ipsfromspreadsheet.search(hash) > -1;

			if (!FoundIp)
			{
				var CommonVideoLinks = [
					'dQw4w9WgXcQ'
				]
				var RareVideoLinks = [
					'Gs069dndIYk',
					'L_jWHffIx5E',
					'v1K4EAXe2oo',
					'vOGhAV-84iI',
					'ZRTCwquyCHc',
					'Tt7bzxurJ1I',
					'gSsJBO2JUO4',
					'3SCBYUE_X1U',
					'SyimUCBIo6c',
					'RRNanbmD1xk',
					'qMQ-y9dHE2k',
					'hgwpZvTWLmE'
				]
	
				const ChanceOfRare = 1/8;
				var CommonOrRare = Math.round(Math.random()) > ChanceOfRare ? false : true;
				var ChosenVideoId;			
				
				if(CommonOrRare)
				{
					ChosenVideoId = CommonVideoLinks[Math.floor(Math.random() * (CommonVideoLinks.length))];
				}
				else
				{
					ChosenVideoId = RareVideoLinks[Math.floor(Math.random() * (RareVideoLinks.length))];
				}
	
				var ChosenVideoUrl = 'https://youtu.be/' + ChosenVideoId;
	
				var JsonUrl = 'https://noembed.com/embed?url=https://www.youtube.com/watch?v=' + ChosenVideoId; 
				var ChosenVideoTitle = await GetJsonTitle(JsonUrl);
				
				var baseUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSf_Z3nol0PQztbRLilbfIA4XSbIXMroVQyyDc-SIpTzkSK5Eg/formResponse?&entry.1267494256=';
				var endUrl = hash + '&submit=SUBMIT';
	
				let iframe = document.getElementById("form");
				iframe.src = baseUrl + endUrl;
	
				LoadVideo(ChosenVideoUrl);

				console.log('Did not Find Ip');
			}
			else
			{
				document.getElementById('scantext').innerHTML = "Hey! No Double Scannsies!";
				console.log('Found Ip');

				setTimeout(function(){
					window.close();
				}, 3000);
			}
		}

		async function GetSpreadSheetData()
		{
			var GetSheetHashedIps = await fetch("https://script.google.com/macros/s/AKfycbyqRbuQoWI7AFltKG2DfU7RvEqWvemJiI9T1z7bkrJnv8CWXQ3vDkDKrcNzxJWcUQK5jA/exec",
				{
					// mode: 'no-cors'
				}).then(response => response.text());

			return await GetSheetHashedIps;
		}

		async function GetJsonTitle(JsonUrl)
		{
			return await fetch(JsonUrl).then(Response => Response.json()).then((out) => { return out.title});
		}

		function LoadVideo(url) {
			setTimeout(function () {
				window.location = url;
				}, 1000);
			}

		function formatAMPM(date) {
			// gets the hours
			var hours = date.getHours();
			// gets the day
			var days = date.getDay();
			// gets the month
			var minutes = date.getMinutes();
			// gets AM/PM
			var ampm = hours >= 12 ? 'pm' : 'am';
			// converts hours to 12 hour instead of 24 hour
			hours = hours % 12;
			// converts 0 (midnight) to 12
			hours = hours ? hours : 12; // the hour '0' should be '12'
			// converts minutes to have leading 0
			minutes = minutes < 10 ? '0' + minutes : minutes;

			// the time string
			var time = hours + ':' + minutes + ' ' + ampm;

			// gets the match for the date string we want
			var match = date.toString().match(/\w{3} \w{3} \d{1,2} \d{4}/);

			//the result
			return match[0] + ' ' + time;
		}

		async function getIP(json) {
			await fetch("https://api.ipify.org")
				.then(res => res.text())
				.then(data => document.getElementById('doc').innerHTML = data);
		}

	</script>
</html>
